<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerador de Assinatura (JPEG)</title>
  <style>
    :root{
      --bg:#0b0d10; --card:#12161c; --muted:#9aa4b2; --text:#e9eef5;
      --stroke:#242c36; --accent:#4f8cff; --danger:#ff5a6a;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #0b0d10 0%, #090b0e 100%);
      color:var(--text);
      padding:24px;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 900px){ .wrap{ grid-template-columns: 1fr; } }
    .card{
      background: rgba(18,22,28,.9);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:16px;
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
    }
    h1{ margin:0 0 10px 0; font-size:18px; font-weight:650; letter-spacing:.2px; }
    p{ margin:0 0 14px 0; color:var(--muted); font-size:13px; line-height:1.4; }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input{
      width:100%;
      padding:12px 12px;
      background:#0e1217;
      color:var(--text);
      border:1px solid var(--stroke);
      border-radius:12px;
      outline:none;
      font-size:14px;
    }
    input:focus{
      border-color: rgba(79,140,255,.65);
      box-shadow: 0 0 0 3px rgba(79,140,255,.18);
    }
    .row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button{
      border:1px solid var(--stroke);
      background:#0e1217;
      color:var(--text);
      padding:12px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      transition: transform .05s ease, border-color .15s ease, opacity .15s ease;
    }
    button:hover{ border-color: rgba(79,140,255,.65); }
    button:active{ transform: translateY(1px); }
    button.primary{
      background: rgba(79,140,255,.15);
      border-color: rgba(79,140,255,.45);
    }
    button.primary:hover{ border-color: rgba(79,140,255,.75); }
    button[disabled]{ opacity:.55; cursor:not-allowed; }
    .error{ color: var(--danger); font-size:12px; margin-top:10px; display:none; }
    .previewHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
    .badge{
      font-size:12px;
      color: var(--muted);
      padding:6px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:#0e1217;
    }
    .canvasWrap{
      background: #0e1217;
      border:1px dashed rgba(154,164,178,.35);
      border-radius:16px;
      padding:14px;
      overflow:auto;
    }
    canvas{
      display:block;
      background:#ffffff;
      border-radius:10px;
      max-width:100%;
      height:auto;
    }
    .fileRow{ display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .fileName{ font-size:12px; color:var(--muted); }
    input[type="file"]{ padding:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <h1>Gerador de assinatura (JPEG)</h1>
      <p>Selecione o layout (PNG/JPG). Depois preencha e baixe. Este fluxo funciona por duplo clique no Chrome.</p>

      <label for="bgFile">Layout (PNG ou JPG)</label>
      <div class="fileRow">
        <input id="bgFile" type="file" accept="image/png,image/jpeg" />
        <span class="fileName" id="bgStatus">Nenhum arquivo selecionado</span>
      </div>

      <label for="fullName">Nome completo</label>
      <input id="fullName" type="text" placeholder="Ex.: Gabriel Rodrigues" />

      <label for="role">Cargo (opcional)</label>
      <input id="role" type="text" placeholder="Ex.: Designer" />

      <label for="contact">Telefone / WhatsApp</label>
      <input id="contact" type="text" placeholder="Ex.: (11) 97887-6929" />

      <label for="email">E-mail (opcional)</label>
      <input id="email" type="text" placeholder="Ex.: gabriel.mrl3@gmail.com" />

      <div class="row">
        <button class="primary" id="btnDownload" type="button" disabled>Baixar JPEG</button>
        <button id="btnClear" type="button">Limpar</button>
      </div>

      <div class="error" id="errorMsg">Selecione um layout e preencha ao menos Nome e Telefone antes de baixar.</div>
    </section>

    <section class="card">
      <div class="previewHead">
        <h1 style="margin:0;">Prévia</h1>
        <span class="badge" id="sizeBadge">400×96</span>
      </div>

      <div class="canvasWrap">
        <canvas id="sigCanvas" width="400" height="96"></canvas>
      </div>
    </section>
  </div>

  <script>
    (function () {
      const canvas = document.getElementById("sigCanvas");
      const ctx = canvas.getContext("2d");

      const bgFileEl = document.getElementById("bgFile");
      const bgStatus = document.getElementById("bgStatus");

      const fullNameEl = document.getElementById("fullName");
      const roleEl = document.getElementById("role");
      const contactEl = document.getElementById("contact");
      const emailEl = document.getElementById("email");

      const btnDownload = document.getElementById("btnDownload");
      const btnClear = document.getElementById("btnClear");
      const errorMsg = document.getElementById("errorMsg");
      const sizeBadge = document.getElementById("sizeBadge");

      const W = canvas.width;   // 400
      const H = canvas.height;  // 96
      sizeBadge.textContent = `${W}×${H}`;

      const fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';

      // Nome/Cargo alinhados à coluna dos ícones
      const NAME_X = 134, NAME_Y = 12;
      const ROLE_X = 134, ROLE_Y = 32;

      // Contatos: X ajustado como você pediu (+3 px vs versão anterior)
      const CONTACT_X = 145;

      // IMPORTANTE: alinhamento vertical pelo CENTRO dos ícones
      // Ajuste fino se necessário: altere +/- 1 ou 2 px.
      const PHONE_CENTER_Y = 60;
      const EMAIL_CENTER_Y = 76;

      // Área segura antes do selo "ig.com.br"
      const RIGHT_SAFE_X = 310;
      const MAX_W_NAME = RIGHT_SAFE_X - NAME_X;
      const MAX_W_CONTACT = RIGHT_SAFE_X - CONTACT_X;

      let bgImg = null;

      function sanitizeText(s, max = 80) {
        return String(s ?? "")
          .replace(/\s+/g, " ")
          .replace(/[\r\n]+/g, " ")
          .trim()
          .slice(0, max);
      }

      function fitText(text, maxWidth, baseSize, minSize, fontWeight) {
        let size = baseSize;
        while (size >= minSize) {
          ctx.font = `${fontWeight} ${size}px ${fontFamily}`;
          if (ctx.measureText(text).width <= maxWidth) return size;
          size -= 1;
        }
        return minSize;
      }

      function drawOverlay() {
        const name = sanitizeText(fullNameEl.value, 60) || "Nome Completo";
        const role = sanitizeText(roleEl.value, 40);
        const phone = sanitizeText(contactEl.value, 60) || "telefone";
        const email = sanitizeText(emailEl.value, 60);

        ctx.textAlign = "left";

        // Nome e cargo por TOP (mais previsível para blocos)
        ctx.textBaseline = "top";

        ctx.fillStyle = "#0b4bff";
        const nameSize = fitText(name, MAX_W_NAME, 18, 12, 700);
        ctx.font = `700 ${nameSize}px ${fontFamily}`;
        ctx.fillText(name, NAME_X, NAME_Y);

        if (role) {
          ctx.fillStyle = "rgba(11, 13, 16, 0.65)";
          const roleSize = fitText(role, MAX_W_NAME, 12, 10, 500);
          ctx.font = `500 ${roleSize}px ${fontFamily}`;
          ctx.fillText(role, ROLE_X, ROLE_Y);
        }

        // Contatos por MIDDLE para bater no centro dos ícones
        ctx.textBaseline = "middle";
        ctx.fillStyle = "rgba(11, 13, 16, 0.85)";

        const phoneSize = fitText(phone, MAX_W_CONTACT, 12, 9, 600);
        ctx.font = `600 ${phoneSize}px ${fontFamily}`;
        ctx.fillText(phone, CONTACT_X, PHONE_CENTER_Y);

        if (email) {
          const emailSize = fitText(email, MAX_W_CONTACT, 12, 9, 600);
          ctx.font = `600 ${emailSize}px ${fontFamily}`;
          ctx.fillText(email, CONTACT_X, EMAIL_CENTER_Y);
        }
      }

      function render() {
        ctx.clearRect(0, 0, W, H);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, W, H);

        if (bgImg) {
          ctx.drawImage(bgImg, 0, 0, W, H);
        } else {
          ctx.fillStyle = "#0b0d10";
          ctx.font = `600 12px ${fontFamily}`;
          ctx.textBaseline = "top";
          ctx.fillText("Selecione um layout (PNG/JPG) para iniciar", 12, 12);
        }

        drawOverlay();
      }

      function downloadJPEG() {
        const name = sanitizeText(fullNameEl.value, 60);
        const phone = sanitizeText(contactEl.value, 60);

        if (!bgImg || !name || !phone) {
          errorMsg.style.display = "block";
          return;
        }
        errorMsg.style.display = "none";

        const safeFile = name
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "")
          .slice(0, 40) || "assinatura";

        canvas.toBlob((blob) => {
          if (!blob) {
            errorMsg.textContent = "Falha ao gerar o JPEG. Recarregue e selecione o layout novamente.";
            errorMsg.style.display = "block";
            return;
          }
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `assinatura-${safeFile}.jpg`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }, "image/jpeg", 0.92);
      }

      function setBackgroundFromFile(file) {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => {
          URL.revokeObjectURL(url);
          bgImg = img;
          btnDownload.disabled = false;
          errorMsg.style.display = "none";
          render();
        };
        img.onerror = () => {
          URL.revokeObjectURL(url);
          bgImg = null;
          btnDownload.disabled = true;
          errorMsg.textContent = "Não foi possível carregar a imagem do layout.";
          errorMsg.style.display = "block";
          render();
        };
        img.src = url;
      }

      function clearAll() {
        fullNameEl.value = "";
        roleEl.value = "";
        contactEl.value = "";
        emailEl.value = "";
        errorMsg.style.display = "none";
        render();
      }

      bgFileEl.addEventListener("change", () => {
        const file = bgFileEl.files && bgFileEl.files[0];
        if (!file) return;
        bgStatus.textContent = file.name;
        setBackgroundFromFile(file);
      });

      fullNameEl.addEventListener("input", render);
      roleEl.addEventListener("input", render);
      contactEl.addEventListener("input", render);
      emailEl.addEventListener("input", render);

      btnDownload.addEventListener("click", downloadJPEG);
      btnClear.addEventListener("click", clearAll);

      render();
    })();
  </script>
</body>
</html>
